---
title: "Estimating knots and Knot-knot Association of PBLSGMs in the framework of individual measurement occasions"
author: Jin Liu
output: rmarkdown::github_document
date: \today
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## OS, R version and OpenMx Version
```{r}
library(OpenMx)
OpenMx::mxOption(model = NULL, key = "Default optimizer", "CSOLNP", reset = FALSE)
OpenMx::mxVersion()
```

## Require package would be used
```{r}
library(tidyr)
library(ggplot2)
```

## First Model: Longitudinal Model with TVC (w/ Interval-specific Slopes)
### Read in dataset for analyses (wide-format data)
```{r, message = F}
source("GMM_TVC1.R")
```

### Summarize data
```{r}
summary(dat[[2]])
```

### Visualize data
```{r}
long_dat_T <- gather(dat[[2]][, c(1, 12:21), ], key = var.T, value = time, T1:T10)
long_dat_Y <- gather(dat[[2]][, c(1, 2:11), ], key = var.Y, value = measuresY, Y1:Y10)
long_dat_Y$outcome <- "Y"
long_dat_TVC <- gather(dat[[2]][, c(1, 22:31), ], key = var.TVC, value = measuresTVC, TVC1:TVC10)
long_dat_TVC$outcome <- "TVC"
long_dat <- data.frame(id = rep(long_dat_T$id, 2),
                       time = rep(long_dat_T$time, 2),
                       measures = c(long_dat_Y$measuresY, long_dat_TVC$measuresTVC),
                       outcome = c(long_dat_Y$outcome, long_dat_TVC$outcome))

ggplot(aes(x = time, y = measures), data = long_dat) +
  geom_line(aes(group = id), color = "lightgrey", linetype = "dotted", 
            data = long_dat[long_dat$outcome == "Y", ]) +
  geom_line(aes(group = id), color = "lightgrey", linetype = "dashed", 
            data = long_dat[long_dat$outcome == "TVC", ]) +
  geom_point(aes(group = id), color = "darkgrey", shape = 0,
             data = long_dat[long_dat$outcome == "Y", ], size = 0.8) +
  geom_point(aes(group = id), color = "darkgrey", shape = 2,
             data = long_dat[long_dat$outcome == "TVC", ], size = 0.8) +
  geom_smooth(aes(group = 1), size = 1.8, col = "lightblue", se = F, 
              data = long_dat[long_dat$outcome == "Y", ] ) + 
  geom_smooth(aes(group = 1), size = 1.8, col = "pink", se = F, 
              data = long_dat[long_dat$outcome == "TVC", ] ) + 
  labs(title = "Longitudinal Outcome and TVC with Individually Varying Measurement Time",
       x ="Time", y = "Measurement") + 
  theme(plot.title = element_text(hjust = 0.5))
```

```{r, message = F}
outTVC
```


## Second Model: Longitudinal Model with TVC (w/ Interval-specific Change)
### Read in dataset for analyses (wide-format data)
```{r, message = F}
source("GMM_TVC2.R")
```

### Summarize data
```{r}
summary(dat[[2]])
```

### Visualize data
```{r}
long_dat_T <- gather(dat[[2]][, c(1, 12:21), ], key = var.T, value = time, T1:T10)
long_dat_Y <- gather(dat[[2]][, c(1, 2:11), ], key = var.Y, value = measuresY, Y1:Y10)
long_dat_Y$outcome <- "Y"
long_dat_TVC <- gather(dat[[2]][, c(1, 22:31), ], key = var.TVC, value = measuresTVC, TVC1:TVC10)
long_dat_TVC$outcome <- "TVC"
long_dat <- data.frame(id = rep(long_dat_T$id, 2),
                       time = rep(long_dat_T$time, 2),
                       measures = c(long_dat_Y$measuresY, long_dat_TVC$measuresTVC),
                       outcome = c(long_dat_Y$outcome, long_dat_TVC$outcome))

ggplot(aes(x = time, y = measures), data = long_dat) +
  geom_line(aes(group = id), color = "lightgrey", linetype = "dotted", 
            data = long_dat[long_dat$outcome == "Y", ]) +
  geom_line(aes(group = id), color = "lightgrey", linetype = "dashed", 
            data = long_dat[long_dat$outcome == "TVC", ]) +
  geom_point(aes(group = id), color = "darkgrey", shape = 0,
             data = long_dat[long_dat$outcome == "Y", ], size = 0.8) +
  geom_point(aes(group = id), color = "darkgrey", shape = 2,
             data = long_dat[long_dat$outcome == "TVC", ], size = 0.8) +
  geom_smooth(aes(group = 1), size = 1.8, col = "lightblue", se = F, 
              data = long_dat[long_dat$outcome == "Y", ] ) + 
  geom_smooth(aes(group = 1), size = 1.8, col = "pink", se = F, 
              data = long_dat[long_dat$outcome == "TVC", ] ) + 
  labs(title = "Longitudinal Outcome and TVC with Individually Varying Measurement Time",
       x ="Time", y = "Measurement") + 
  theme(plot.title = element_text(hjust = 0.5))
```

```{r, message = F}
outTVC
```






## Third Model: Longitudinal Model with TVC (w/ Change from Baseline)
### Read in dataset for analyses (wide-format data)
```{r, message = F}
source("GMM_TVC3.R")
```

### Summarize data
```{r}
summary(dat[[2]])
```

### Visualize data
```{r}
long_dat_T <- gather(dat[[2]][, c(1, 12:21), ], key = var.T, value = time, T1:T10)
long_dat_Y <- gather(dat[[2]][, c(1, 2:11), ], key = var.Y, value = measuresY, Y1:Y10)
long_dat_Y$outcome <- "Y"
long_dat_TVC <- gather(dat[[2]][, c(1, 22:31), ], key = var.TVC, value = measuresTVC, TVC1:TVC10)
long_dat_TVC$outcome <- "TVC"
long_dat <- data.frame(id = rep(long_dat_T$id, 2),
                       time = rep(long_dat_T$time, 2),
                       measures = c(long_dat_Y$measuresY, long_dat_TVC$measuresTVC),
                       outcome = c(long_dat_Y$outcome, long_dat_TVC$outcome))

ggplot(aes(x = time, y = measures), data = long_dat) +
  geom_line(aes(group = id), color = "lightgrey", linetype = "dotted", 
            data = long_dat[long_dat$outcome == "Y", ]) +
  geom_line(aes(group = id), color = "lightgrey", linetype = "dashed", 
            data = long_dat[long_dat$outcome == "TVC", ]) +
  geom_point(aes(group = id), color = "darkgrey", shape = 0,
             data = long_dat[long_dat$outcome == "Y", ], size = 0.8) +
  geom_point(aes(group = id), color = "darkgrey", shape = 2,
             data = long_dat[long_dat$outcome == "TVC", ], size = 0.8) +
  geom_smooth(aes(group = 1), size = 1.8, col = "lightblue", se = F, 
              data = long_dat[long_dat$outcome == "Y", ] ) + 
  geom_smooth(aes(group = 1), size = 1.8, col = "pink", se = F, 
              data = long_dat[long_dat$outcome == "TVC", ] ) + 
  labs(title = "Longitudinal Outcome and TVC with Individually Varying Measurement Time",
       x ="Time", y = "Measurement") + 
  theme(plot.title = element_text(hjust = 0.5))
```

```{r, message = F}
outTVC
```



